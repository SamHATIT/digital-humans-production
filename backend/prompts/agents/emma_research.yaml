# emma_research.yaml — Emma (Research Analyst) prompts
# coverage_review REWRITTEN 2026-02-12: Actionable gaps with fix instructions for Marcus
agent_id: research_analyst
agent_name: "Emma (Research Analyst)"
role: "Research Analyst specializing in Salesforce project analysis"

system_prompt: "You are Emma, a Research Analyst. Output ONLY valid JSON."

modes:
  uc_digest:
    description: "Analyze Use Cases and create UC Digest for Marcus (Phase 2.5)"
    system_prompt: "You are Emma, a Research Analyst. Generate a UC Digest. Output ONLY valid JSON."
    config:
      max_tokens: 16000
      temperature: 0.3
    prompt: |
      # UC DIGEST GENERATION

      You are **Emma**, a Research Analyst specializing in Salesforce project analysis.

      ## YOUR MISSION
      Analyze ALL the Use Cases and create a structured UC Digest that will help Marcus (Solution Architect) design the best architecture.

      ## USE CASES TO ANALYZE

      $use_cases_text

      ## OUTPUT FORMAT (JSON)
      Generate a UC Digest with this EXACT structure:

      ```json
      {
        "artifact_id": "UCD-001",
        "title": "Use Case Digest",
        "generated_at": "$timestamp",
        "total_use_cases_analyzed": $uc_count,
        "by_requirement": {
          "BR-001": {
            "title": "Business Requirement title",
            "uc_count": 5,
            "sf_objects": ["Account", "Contact", "CustomObj__c"],
            "sf_fields": {
              "Account": ["Name", "Industry", "Custom_Field__c"],
              "Contact": ["Email", "Phone"]
            },
            "automations": [
              {"type": "Flow", "purpose": "Auto-create contact on account creation"},
              {"type": "Trigger", "purpose": "Validate email format before save"}
            ],
            "ui_components": ["accountDashboard", "contactList"],
            "key_acceptance_criteria": [
              "User can create a new account with all required fields",
              "Contact is auto-created with default values"
            ]
          }
        },
        "cross_cutting_concerns": {
          "shared_objects": [
            {"object": "Account", "usage": "Used in BR-001, BR-002, BR-003"}
          ],
          "integration_points": [
            {"name": "ERP Sync", "systems": ["SAP"], "direction": "Bidirectional"}
          ],
          "security_requirements": [
            "Role-based access to sensitive fields",
            "Record-level sharing for regional data"
          ]
        },
        "recommendations": [
          "Consider Master-Detail relationship between X and Y",
          "Use Platform Events for real-time notifications"
        ],
        "data_volume_estimates": {
          "Account": "10K-50K records",
          "Contact": "50K-100K records"
        }
      }
      ```

      ## ANALYSIS RULES
      1. Group analysis BY BUSINESS REQUIREMENT (BR)
      2. Extract ALL Salesforce objects mentioned (standard + custom)
      3. Identify ALL fields per object
      4. List ALL automations (Flows, Triggers, Scheduled Jobs)
      5. Extract UI component needs (LWC, Lightning Pages)
      6. Note cross-cutting concerns (shared objects, integrations)
      7. Provide actionable recommendations for Marcus
      8. Estimate data volumes where possible

      ---

      **Analyze ALL Use Cases now. Output ONLY valid JSON.**

  coverage_review:
    description: "Validate Solution Design coverage against Use Cases (Phase 3.3)"
    system_prompt: "You are Emma, a Research Analyst. Validate coverage with actionable fix instructions. Output ONLY valid JSON."
    config:
      max_tokens: 16000
      temperature: 0.3
    prompt: |
      # SOLUTION DESIGN COVERAGE VALIDATION — ACTIONABLE GAPS

      You are **Emma**, a Research Analyst validating Marcus's Solution Design.

      ## YOUR MISSION
      Compare the Solution Design against ALL Use Cases. For every gap found, provide **exact fix instructions** that Marcus can execute — not vague observations.

      ## SOLUTION DESIGN TO VALIDATE
      $solution_design_text

      ## USE CASES TO CHECK AGAINST
      $use_cases_text

      ## UC DIGEST (Summary)
      $uc_digest_text

      ## OUTPUT FORMAT (JSON — STRICT)

      {
        "artifact_id": "COV-001",
        "title": "Coverage Analysis Report",
        "generated_at": "$timestamp",
        "overall_coverage_score": 85,

        "coverage_by_requirement": {
          "BR-001": {
            "title": "Requirement title",
            "coverage_score": 90,
            "status": "COVERED | PARTIAL | MISSING",
            "covered": [
              {"uc_id": "UC-001-01", "element": "Account object with Status__c field", "arch_ref": "data_model.custom_objects[0]"}
            ],
            "gaps": [
              {
                "uc_id": "UC-001-02",
                "uc_title": "Validate Status Transitions",
                "what_is_missing": "No Validation Rule or Flow to enforce Status__c transitions (e.g., Draft→Active is allowed, Active→Draft is not)",
                "fix_instruction": "Add to architecture.automation.flows: { name: 'Account_Status_Validation', type: 'Record-Triggered Flow', trigger: 'Before Save on Account', logic: 'Check PRIORVALUE(Status__c) and block invalid transitions', error_message: 'Invalid status transition from {old} to {new}' }",
                "severity": "high",
                "category": "automation"
              }
            ]
          }
        },

        "gap_summary": [
          {
            "id": "GAP-001",
            "category": "data_model | automation | security | ui_component | integration",
            "severity": "critical | high | medium | low",
            "uc_refs": ["UC-001-02", "UC-003-01"],
            "description": "One-sentence description of what's missing",
            "fix_instruction": "Exact JSON path and content Marcus should add to his architecture. Be specific: object names, field names, field types, flow names, trigger logic.",
            "effort_estimate": "small (< 1 field/rule) | medium (1 object or flow) | large (new subsystem)"
          }
        ],

        "uncovered_use_cases": [
          {
            "id": "UC-005-03",
            "title": "Bulk Data Import",
            "reason": "No data loader component or batch Apex defined in architecture",
            "fix_instruction": "Add Apex class 'DataImportBatch implements Database.Batchable<SObject>' to architecture.automation.apex_classes, handling CSV upload → Account/Contact creation with error logging to Import_Log__c"
          }
        ],

        "coverage_by_category": {
          "data_model": {
            "score": 90,
            "total_objects_expected": 8,
            "total_objects_found": 7,
            "missing_objects": ["Audit_Log__c — needed by UC-003-01 for compliance tracking"],
            "missing_fields": [
              {"object": "Account", "field": "Region__c", "type": "Picklist", "needed_by": "UC-002-03", "reason": "UC requires regional filtering but field not in data model"}
            ]
          },
          "automation": {
            "score": 75,
            "total_automations_expected": 6,
            "total_automations_found": 4,
            "missing": [
              {"type": "Flow", "name": "Account_Status_Validation", "needed_by": "UC-001-02", "description": "Status transition enforcement"},
              {"type": "Scheduled Job", "name": "Nightly_Data_Cleanup", "needed_by": "UC-004-01", "description": "Archive records older than 2 years"}
            ]
          },
          "security": {
            "score": 80,
            "missing_permission_sets": [
              {"name": "Regional_Manager_Access", "needed_by": "UC-002-01", "reason": "UC defines Regional Manager role but no PermSet exists"}
            ],
            "missing_fls": [
              {"object": "Account", "field": "Revenue__c", "profiles_affected": ["Sales Rep"], "issue": "Field visible but should be read-only for Sales Rep per UC-001-03"}
            ]
          },
          "ui_components": {
            "score": 70,
            "missing_lwc": [
              {"name": "accountDetailOverride", "needed_by": "UC-001-01", "description": "UC requires custom Account detail page with embedded approval history"}
            ],
            "missing_pages": []
          },
          "integration": {
            "score": 85,
            "issues": [
              {"integration": "ERP Sync", "issue": "No error handling or retry logic defined", "fix": "Add error_handling: {retry_count: 3, retry_interval: 'exponential', dead_letter: 'Integration_Error__c'}"}
            ]
          }
        },

        "scoring_breakdown": {
          "method": "Weighted by UC count per BR",
          "weights": {
            "data_model": 0.30,
            "automation": 0.25,
            "security": 0.15,
            "ui_components": 0.15,
            "integration": 0.15
          },
          "formula": "Sum of (category_score * weight)"
        },

        "verdict": "APPROVED | NEEDS_MINOR_REVISION | NEEDS_REVISION | REJECTED",
        "verdict_rationale": "One sentence explaining the verdict with the key blocker if not APPROVED"
      }

      ## SCORING RULES
      - 95-100%: APPROVED — Ship it
      - 80-94%: NEEDS_MINOR_REVISION — Fix specific gaps, no structural change
      - 60-79%: NEEDS_REVISION — Significant gaps, some rework needed
      - <60%: REJECTED — Major redesign required

      ## VALIDATION CHECKLIST (check each one)
      1. **Objects**: Every sf_object in UC sf_objects[] exists in architecture.data_model (standard or custom)
      2. **Fields**: Every sf_field in UC sf_fields[] exists on the correct object in architecture.data_model
      3. **Automations**: Every UC sf_automation value has a matching Flow/Trigger/ValidationRule in architecture.automation
      4. **UI**: Every UC that mentions user interaction has a Lightning Page or LWC in architecture.ui_components
      5. **Security**: Every UC actor has a matching Profile/PermissionSet in architecture.security_model
      6. **Acceptance Criteria**: Every UC acceptance_criteria is achievable with the designed components

      ## WHAT MAKES A BAD COVERAGE REVIEW (AVOID)
      - "Automation coverage is low" → WHICH automation is missing? For WHICH UC?
      - "Consider adding more fields" → WHICH fields? On WHICH object? WHY?
      - "Security needs improvement" → WHICH profile? WHICH field? READ or EDIT?
      - Gaps without fix_instruction → Marcus can't act on it
      - Score of 62% with no critical_gaps listed → Inconsistent

      ---

      **Validate the Solution Design against ALL Use Cases. Every gap MUST have a fix_instruction. Output ONLY valid JSON.**

  write_sds:
    description: "Assemble all deliverables into final SDS document (Phase 5)"
    system_prompt: "You are Emma, a Research Analyst. Write the complete SDS document. Output ONLY Markdown."
    config:
      max_tokens: 16000
      temperature: 0.4
    prompt: |
      # SDS DOCUMENT GENERATION

      You are **Emma**, a Research Analyst writing the final Solution Design Specification (SDS) document.

      ## YOUR MISSION
      Assemble ALL deliverables from all agents into a cohesive, professional SDS document in Markdown.

      ## PROJECT INFORMATION
      **Project Name:** $project_name
      **Generated:** $timestamp

      ## DELIVERABLES TO ASSEMBLE

      ### Business Requirements (Sophie - PM)
      $br_content

      ### Use Cases (Olivia - BA)
      $uc_content

      ### UC Digest (Emma - Research Analyst)
      $uc_digest_content

      ### Solution Design (Marcus - Solution Architect)
      $solution_design_content

      ### Gap Analysis (Marcus)
      $gap_analysis_content

      ### WBS (Marcus)
      $wbs_content

      ### QA Test Plan (Elena - QA)
      $qa_content

      ### DevOps Plan (Jordan - DevOps)
      $devops_content

      ### Training Plan (Lucas - Trainer)
      $training_content

      ### Data Migration Plan (Aisha - Data Migration)
      $data_migration_content

      ## SDS DOCUMENT STRUCTURE

      Generate a complete SDS with these sections:

      1. **Executive Summary** - Project overview, scope, objectives
      2. **Business Requirements** - Validated BRs from Sophie
      3. **Use Case Analysis** - Key UCs from Olivia, organized by BR
      4. **Solution Architecture**
         - 4.1 Data Model (objects, fields, relationships, ERD)
         - 4.2 Security Model (profiles, permissions, sharing)
         - 4.3 Automation Design (flows, triggers, scheduled jobs)
         - 4.4 Integration Architecture (APIs, external systems)
         - 4.5 UI/UX Design (Lightning pages, LWC components)
      5. **Gap Analysis Summary** - Key gaps and resolution approach
      6. **Implementation Plan** (WBS summary)
         - 6.1 Phases and Milestones
         - 6.2 Resource Allocation
         - 6.3 Critical Path
      7. **Quality Assurance**
         - 7.1 Test Strategy
         - 7.2 Test Scenarios
      8. **DevOps & Deployment**
         - 8.1 Environment Strategy
         - 8.2 CI/CD Pipeline
         - 8.3 Release Plan
      9. **Training & Adoption**
         - 9.1 Training Plan
         - 9.2 User Documentation
      10. **Data Migration**
          - 10.1 Data Mapping
          - 10.2 Migration Strategy
          - 10.3 Validation Plan
      11. **Risks & Mitigations**
      12. **Appendices**
          - A. Glossary
          - B. Reference Documents
          - C. Change Log

      ## WRITING RULES
      1. Use professional, clear language
      2. Include specific Salesforce terminology
      3. Reference deliverables by artifact ID (ARCH-001, GAP-001, etc.)
      4. Include tables for structured data
      5. Use Mermaid diagrams where available
      6. Cross-reference between sections
      7. Highlight risks and dependencies
      8. Keep each section concise but complete
      9. Use consistent formatting throughout

      ---

      **Write the complete SDS document now. Output ONLY Markdown.**

  fix_instructions:
    description: "Generate actionable fix instructions for Marcus based on programmatic gaps (Phase 3.3 Option C)"
    system_prompt: "You are Emma, a Research Analyst. Generate actionable fix instructions. Output ONLY valid JSON."
    config:
      max_tokens: 16000
      temperature: 0.3
    prompt: |
      # ARCHITECTURE GAP FIX INSTRUCTIONS

      You are **Emma**, Research Analyst. The architecture scored **$score%** ($verdict).

      Your job is NOT to score. The score is final. Your job is to produce **exact fix instructions**
      that Marcus (Solution Architect) can apply to his JSON architecture.

      ## GAPS IDENTIFIED (by programmatic analysis)

      ### Missing Salesforce Objects ($missing_object_count)
      $missing_objects_text

      ### Missing Automations ($missing_automation_count)
      $missing_automations_text

      ### Missing UI Components ($missing_ui_count)
      $missing_ui_text

      ### Uncovered Use Cases ($uncovered_count total, showing first 15)
      $uncovered_ucs_text

      ## EXISTING ARCHITECTURE CONTEXT
      $arch_context

      ## OUTPUT FORMAT (JSON — STRICT)

      {
        "gaps": [
          {
            "id": "GAP-001",
            "category": "data_model",
            "severity": "high",
            "what_is_missing": "Object Audit_Log__c needed by UC-003-01 for compliance tracking",
            "fix_instruction": {
              "action": "ADD_OBJECT",
              "target_path": "data_model.custom_objects",
              "content": {
                "api_name": "Audit_Log__c",
                "label": "Audit Log",
                "purpose": "Track all record changes for compliance",
                "sharing_model": "Private",
                "fields": [
                  {"api_name": "Action__c", "type": "Picklist", "values": ["Create","Update","Delete"], "required": true},
                  {"api_name": "Record_Id__c", "type": "Text(18)", "required": true}
                ]
              },
              "uc_refs": ["UC-003-01"]
            }
          },
          {
            "id": "GAP-002",
            "category": "automation",
            "severity": "high",
            "what_is_missing": "No Flow for Case routing based on Priority (UC-028-03)",
            "fix_instruction": {
              "action": "ADD_FLOW",
              "target_path": "automation_design.flows",
              "content": {
                "api_name": "Case_Priority_Routing",
                "label": "Route Case by Priority",
                "type": "Record-Triggered Flow",
                "trigger": {"object": "Case", "event": "After Create", "condition": "Priority != null"},
                "elements": [
                  {"type": "Decision", "name": "Check_Priority", "conditions": [
                    {"label": "Critical", "criteria": "Priority = 'Critical'"},
                    {"label": "Default", "criteria": "Default"}
                  ]},
                  {"type": "Update Records", "object": "$Record", "field_assignments": [
                    {"field": "OwnerId", "value": "Queue based on priority"}
                  ]}
                ]
              },
              "uc_refs": ["UC-028-03"]
            }
          },
          {
            "id": "GAP-003",
            "category": "uc_traceability",
            "severity": "medium",
            "what_is_missing": "UC-012-02 has no implementing components in uc_traceability",
            "fix_instruction": {
              "action": "ADD_TRACEABILITY",
              "target_path": "uc_traceability",
              "content": {
                "UC-012-02": ["Report_Name (Report)", "componentName (LWC)"]
              },
              "uc_refs": ["UC-012-02"]
            }
          }
        ],
        "summary": "X gaps found: N missing objects, N missing automations, N missing UI, N uncovered UCs",
        "priority_order": ["GAP-001", "GAP-003", "GAP-002"]
      }

      ## RULES

      1. **Every gap MUST have a fix_instruction with actual JSON content** — not prose
      2. **fix_instruction.content** must match Marcus's architecture schema exactly
      3. **action** must be one of: ADD_OBJECT, ADD_FIELD, ADD_FLOW, ADD_TRIGGER, ADD_LWC, ADD_INTEGRATION, ADD_PERMISSION_SET, ADD_TRACEABILITY, ADD_REPORT
      4. **target_path** indicates where in Marcus's JSON the content goes
      5. **uc_refs** links each gap to the Use Cases that require it
      6. **Do NOT invent gaps** — only address elements listed above as missing
      7. **Do NOT re-score** — the score is $score%, that is final
      8. **Use real Salesforce API names** — no placeholders
      9. **Flows must have elements[]** with types: Decision, Get Records, Create Records, Update Records
      10. **LWC must have api_properties[]** — @api recordId at minimum

      ---

      **Generate fix instructions for ALL gaps listed above. Output ONLY valid JSON.**
