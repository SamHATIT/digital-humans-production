# Digital Humans - Journal de Session

---

## 2026-01-26 - SDS v3 COMPLET ✅

### Réalisations
- **sds_synthesis_service.py** créé (agrégation par domaine + synthèse Claude)
- **Routes API** ajoutées: /synthesize, /domains-summary, /sds-preview
- **Test réussi**: 8 UCs → 3 domaines → $0.11 (vs $10-12 avant)
- **Clé Anthropic** ajoutée dans backend/.env (était dans racine uniquement)
- Script démarrage `/tmp/start_backend.sh` pour charger .env

### Résultats test SDS v3
- Case Management: 4 UCs, 3564 tokens, $0.036
- Customer Management: 3 UCs, 4891 tokens, $0.055  
- Communication: 1 UC, 2219 tokens, $0.023
- **Total: 10,674 tokens, $0.11, 53s**

### Fichiers modifiés
- backend/app/services/sds_synthesis_service.py (nouveau)
- backend/app/api/routes/pm_orchestrator.py (+routes)
- backend/.env (+ANTHROPIC_API_KEY)

### Commits
- feat(sds-v3): Service synthèse par domaine + routes API

### Prochaine session
1. Génération DOCX (pas juste Markdown)
2. Test sur 120+ UCs
3. Validation cohérence Emma

---

## 2026-01-27 - SDS-07 DOCX Generator ✅

### Réalisations
- **sds_docx_generator_v3.py** créé (661 lignes)
  - Style professionnel inspiré LVMH/Shiseido
  - Page titre avec infos projet
  - Table des matières automatique Word
  - Styles personnalisés (Calibri, couleurs corporate)
  - Tableaux avec en-têtes colorés (#1F4E79)
  - Conversion Mermaid → PNG via Kroki.io (avec fallback texte)
  - Sections par domaine fonctionnel
  - ERD, matrice permissions, WBS
  - Annexes avec métadonnées génération

- **Routes API ajoutées**:
  - POST `/execute/{id}/generate-docx` - Génère le DOCX
  - GET `/execute/{id}/download-sds-v3` - Télécharge le SDS

- **Tag Git créé**: `v1-full-workflow-backup` (rollback si besoin)

### Test réussi
- Exécution 86: 8 UCs → 3 domaines
- Synthèse: $0.11, ~55s
- DOCX: 45.6 KB
- Erreur Kroki (syntaxe ERD) → fallback OK

### Fichiers modifiés
- backend/app/services/sds_docx_generator_v3.py (nouveau)
- backend/app/api/routes/pm_orchestrator.py (+routes)
- features.json (SDS-07 completed, +7 BILLING features)

### Commits
- c212932: feat(billing): Add BILLING-001 to 005 + SDS-07 + BUILD-TEST-001
- 99806a6: feat(sds-v3): Add DOCX generator with professional styling

### Prochaine session
1. Corriger la syntaxe ERD Mermaid dans sds_synthesis_service.py
2. Tester sur une exécution complète (pas juste micro-analyse)
3. Intégrer le flux v3 dans pm_orchestrator_service_v2.py
4. Ajouter en-têtes/pieds de page au DOCX
5. Test avec plus de UCs (120+)

## 2026-01-27 (suite) - Intégration complète SDS v3

### Corrections et intégration

**Backend:**
- Corrigé `generate_erd_mermaid()` avec fonction `clean_name()` pour nettoyer les caractères spéciaux
- Ajouté route complète `/execute/{id}/generate-sds-v3` pour pipeline complet
- Amélioré `/execute/{id}/download-sds-v3` pour servir les fichiers existants
- Import BackgroundTasks ajouté

**Frontend:**
- Créé composant `SDSv3Generator.tsx` avec UI moderne (stats, progress, download)
- Ajouté fonctions API: `generateSDSv3()`, `downloadSDSv3()`, `getSDSv3Preview()`
- Intégré dans `ExecutionMonitoringPage.tsx` (visible après BR validation)

### État des services
- Backend: http://localhost:8002 ✅
- Frontend: http://localhost:3000 ✅
- Accessible via: http://72.61.161.222

### Test manuel
1. Se connecter sur http://72.61.161.222
2. Aller sur un projet avec des Use Cases générés
3. Cliquer sur "Générer SDS v3 (DOCX)"
4. Télécharger le document

### Commits
- d2d2e85: feat(sds-v3): Full pipeline integration with web UI
- b2fd8a5: fix(sds-v3): Improve download route to serve existing files

## Session 2026-01-27 14:45 - Corrections critiques workflow SDS

### Problèmes résolus

1. **Login frontend cassé**
   - Cause: VITE_API_URL pointait vers port 8002 direct au lieu du proxy nginx
   - Fix: `.env` → `VITE_API_URL=` (vide pour utiliser URLs relatives)

2. **N8N site vitrine down**
   - Cause: Service N8N arrêté
   - Fix: Redémarré manuellement `nohup n8n start`

3. **Agents path introuvable**
   - Cause: Chemins Docker `/app/agents/roles/` au lieu du VPS
   - Fix: `pm_orchestrator_service_v2.py` et `agent_executor.py` → `/root/workspace/.../backend/agents/roles`

4. **Agents enchaînent sans données (BUG CRITIQUE)**
   - Cause: `resume_from="phase1"` skipait Phase 1 car condition `"phase1" != "phase1_pm"` était vraie
   - Fix: Condition corrigée `resume_from not in (None, "phase1", "phase1_pm")`
   - Fix: Gate validation avant Phase 2 (vérifie BRs > 0)
   - Fix: Gate validation après Phase 2 (vérifie UCs > 0)

### Fichiers modifiés
- `backend/app/services/pm_orchestrator_service_v2.py` (condition resume_from + 2 gates)
- `backend/app/services/agent_executor.py` (AGENTS_PATH)
- `frontend/.env` (VITE_API_URL)

### Bug noté pour plus tard
- SDSv3Generator s'affiche dès le début au lieu d'après Olivia

### Tokens consommés par erreur
- ~27,000 tokens Claude Sonnet perdus sur exécution 129 (agents ont tourné avec 0 BRs/UCs)

### Prochaine étape
- Tester nouveau projet avec workflow complet (Sophie→BRs→validation→Olivia→UCs)

## Session 2026-01-27 19:15 - Test workflow complet SDS réussi

### Résultat principal
✅ **Premier SDS de qualité professionnelle généré avec succès**
- Projet : Gestion de la formation professionnelle (Formapro)
- Exécution : #130
- Coût : ~5€
- Qualité : Validée par Sam comme "bien plus professionnel que tout ce qu'on a fait à ce jour"

### Workflow validé
1. Sophie extrait 15 BRs → WAITING_BR_VALIDATION ✅
2. Utilisateur valide les BRs (après hard refresh navigateur)
3. Olivia génère les UCs ✅
4. Emma, Marcus et suite complètent le SDS ✅
5. Document DOCX généré et chargé en mémoire projet

### Problèmes rencontrés et résolus
- **Cache navigateur** : Hard refresh (Ctrl+Shift+R) nécessaire pour voir le bouton de validation BRs
- **Gates de validation** : Fonctionnent correctement (ajoutées session précédente)

### Points à améliorer identifiés

1. **Estimation des durées (244 j/h dans le SDS)**
   - Actuellement : Marcus génère les estimations sans règles métier explicites
   - Le prompt dit seulement "Realistic effort estimates"
   - À faire : Ajouter un barème d'estimation basé sur standards consulting SF

2. **Bouton SDS v3 Generator**
   - Redondant actuellement - le pipeline standard génère déjà le SDS complet
   - Ce bouton était prévu pour le pipeline micro-analyse (Ollama/Nemo → ~0.10€)
   - Pipeline actuel fonctionne mais coûte 5€ vs 0.10€ visé

3. **Comparatif temps estimé vs temps réel BUILD**
   - À faire : Lancer le BUILD et mesurer le temps réel par tâche
   - Objectif : Comparer 244 j/h estimés humain vs temps réel agents IA
   - Intégrer ce comparatif dans le document SDS une fois données collectées

### Prochaine étape
- Approuver le SDS sur la page projet
- Lancer le BUILD phase
- Mesurer les temps réels par tâche pour comparatif

### État du projet #84
- Status : SDS_GENERATED
- Exécution #130 : COMPLETED
- Prêt pour approbation SDS puis BUILD
